services:
  song-metadata-mcp:
    build: ./mcp/song_metadata
    volumes:
      - ./analyzer/meta:/app/meta:ro
    environment:
      - SONG_METADATA_MCP_META_ROOT=/app/meta
      - SONG_METADATA_MCP_HOST=0.0.0.0
      - SONG_METADATA_MCP_PORT=8081
      - SONG_METADATA_MCP_TRANSPORT=sse
      - SONG_METADATA_MCP_MAX_RAW_POINTS=${SONG_METADATA_MCP_MAX_RAW_POINTS:-20000}
      - SONG_METADATA_MCP_DEFAULT_MAX_POINTS=${SONG_METADATA_MCP_DEFAULT_MAX_POINTS:-5000}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8081/sse >/dev/null || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  analyzer:
    build: ./analyzer
    volumes:
      - ./analyzer:/app/analyzer
      - ./backend/songs:/app/songs
      - ./analyzer/meta:/app/meta
      - analyzer_cache:/root/.cache
    gpus: all
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    restart: unless-stopped

  backend:
    build: ./backend
    ports:
      - "5001:5001"
    volumes:
      - ./backend/songs:/app/songs
      - ./backend/fixtures:/app/fixtures
      - ./backend/cues:/app/cues
      - ./analyzer/meta:/app/meta
    environment:
      - DMX_NODE_IP=192.168.10.221
      - FPS=60
      - ARTNET_DEBUG=${ARTNET_DEBUG:-0}
      - ARTNET_DEBUG_FILE=${ARTNET_DEBUG_FILE:-}
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
    ports:
      - "9000:80"
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  analyzer_cache:
